{% extends "base.html" %}

{% block title %}Fortress Statistics - Dwarf Fortress Container Manager{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h1 class="text-white">
            <i class="fas fa-fort-awesome"></i> Fortress Statistics
            <small class="text-white-50">Real-time game data analysis</small>
        </h1>
    </div>
</div>

<!-- Fortress Overview -->
<div class="row mb-4" id="fortress-overview">
    <div class="col-md-3 mb-3">
        <div class="card fortress-stats h-100">
            <div class="card-body metric-card">
                <i class="fas fa-mountain fa-2x mb-3"></i>
                <div class="metric-value" id="fortress-name">Loading...</div>
                <div class="metric-label">Fortress Name</div>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="card container-health h-100">
            <div class="card-body metric-card">
                <i class="fas fa-calendar-alt fa-2x mb-3"></i>
                <div class="metric-value" id="game-time">-</div>
                <div class="metric-label">Game Time</div>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="card h-100" style="background: linear-gradient(135deg, #6c5ce7, #a29bfe); color: white;">
            <div class="card-body metric-card">
                <i class="fas fa-users fa-2x mb-3"></i>
                <div class="metric-value" id="total-population">-</div>
                <div class="metric-label">Total Population</div>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="card h-100" style="background: linear-gradient(135deg, #fdcb6e, #f39c12); color: white;">
            <div class="card-body metric-card">
                <i class="fas fa-coins fa-2x mb-3"></i>
                <div class="metric-value" id="total-wealth">-</div>
                <div class="metric-label">Total Wealth</div>
            </div>
        </div>
    </div>
</div>

<!-- Population Breakdown -->
<div class="row mb-4">
    <div class="col-12">
        <h3 class="text-white mb-3">
            <i class="fas fa-users"></i> Population Management
        </h3>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-chart-pie"></i> Population Distribution
                </h5>
            </div>
            <div class="card-body">
                <canvas id="populationChart" height="300"></canvas>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-list-alt"></i> Population Details
                </h5>
            </div>
            <div class="card-body">
                <div id="population-details">
                    <!-- Population details will be populated here -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Wealth Analysis -->
<div class="row mb-4">
    <div class="col-12">
        <h3 class="text-white mb-3">
            <i class="fas fa-coins"></i> Economic Overview
        </h3>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-chart-bar"></i> Wealth Breakdown
                </h5>
            </div>
            <div class="card-body">
                <canvas id="wealthChart" height="200"></canvas>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-trophy"></i> Wealth Categories
                </h5>
            </div>
            <div class="card-body">
                <div id="wealth-categories">
                    <!-- Wealth categories will be populated here -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Fortress Status -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-heartbeat"></i> Fortress Health & Status
                </h5>
                <div>
                    <button class="btn btn-primary btn-sm" onclick="exportFortressData()">
                        <i class="fas fa-download"></i> Export Data
                    </button>
                    <button class="btn btn-secondary btn-sm" onclick="refreshFortressData()">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <div class="d-flex align-items-center mb-3">
                            <div class="me-3">
                                <i class="fas fa-smile fa-2x text-success"></i>
                            </div>
                            <div>
                                <div class="fw-bold">Fortress Mood</div>
                                <div id="fortress-mood" class="text-muted">Unknown</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="d-flex align-items-center mb-3">
                            <div class="me-3">
                                <i class="fas fa-shield-alt fa-2x text-info"></i>
                            </div>
                            <div>
                                <div class="fw-bold">Military Status</div>
                                <div id="military-status" class="text-muted">Unknown</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="d-flex align-items-center mb-3">
                            <div class="me-3">
                                <i class="fas fa-exclamation-triangle fa-2x text-warning"></i>
                            </div>
                            <div>
                                <div class="fw-bold">Active Alerts</div>
                                <div id="active-alerts" class="text-muted">None</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Data Connection Status -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-database"></i> Data Connection Status
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <div id="api-status">
                            <div class="d-flex align-items-center">
                                <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                                <span>Checking API connection...</span>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div id="last-update">
                            <small class="text-muted">Last update: Never</small>
                        </div>
                    </div>
                </div>
                <div class="mt-3">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        <strong>How to get live data:</strong>
                        <ol class="mb-0 mt-2">
                            <li>Start Dwarf Fortress game via <a href="http://localhost:6080" target="_blank">noVNC</a></li>
                            <li>In DFHack console, run: <code>script /opt/dwarf-fortress/scripts/export_fortress_data.lua</code></li>
                            <li>Data will automatically appear here when exported</li>
                        </ol>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
let fortressData = {};
let populationChart = null;
let wealthChart = null;

async function refreshFortressData() {
    try {
        const response = await fetch('/api/fortress-stats');
        fortressData = await response.json();
        
        updateFortressDisplay();
        updateAPIStatus(true);
    } catch (error) {
        console.error('Failed to fetch fortress data:', error);
        updateAPIStatus(false, error.message);
        showError('Failed to fetch fortress data');
    }
}

function updateFortressDisplay() {
    // Update overview metrics
    updateOverviewMetrics();
    
    // Update charts
    updatePopulationChart();
    updateWealthChart();
    
    // Update population details
    updatePopulationDetails();
    
    // Update wealth categories
    updateWealthCategories();
    
    // Update fortress status
    updateFortressStatus();
    
    // Update last update time
    document.getElementById('last-update').innerHTML = 
        `<small class="text-muted">Last update: ${new Date().toLocaleTimeString()}</small>`;
}

function updateOverviewMetrics() {
    const fortressName = fortressData.fortress_info?.name || 'Unknown Fortress';
    const year = fortressData.fortress_info?.year || 0;
    const season = fortressData.fortress_info?.season || 'Unknown';
    const totalPop = fortressData.population?.total || 0;
    const totalWealth = fortressData.wealth?.total || 0;
    
    document.getElementById('fortress-name').textContent = fortressName;
    document.getElementById('game-time').textContent = `${year} ${season}`;
    document.getElementById('total-population').textContent = totalPop.toLocaleString();
    document.getElementById('total-wealth').textContent = totalWealth.toLocaleString();
}

function updatePopulationChart() {
    const population = fortressData.population || {};
    const data = [
        { label: 'Dwarves', value: population.dwarves || 0, color: 'rgba(255, 99, 132, 0.8)' },
        { label: 'Animals', value: population.animals || 0, color: 'rgba(54, 162, 235, 0.8)' },
        { label: 'Military', value: population.military || 0, color: 'rgba(255, 205, 86, 0.8)' },
        { label: 'Visitors', value: population.visitors || 0, color: 'rgba(75, 192, 192, 0.8)' }
    ].filter(item => item.value > 0);
    
    const ctx = document.getElementById('populationChart').getContext('2d');
    
    if (populationChart) {
        populationChart.destroy();
    }
    
    populationChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: data.map(item => item.label),
            datasets: [{
                data: data.map(item => item.value),
                backgroundColor: data.map(item => item.color),
                borderWidth: 2,
                borderColor: '#fff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const label = context.label || '';
                            const value = context.parsed || 0;
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                            return `${label}: ${value} (${percentage}%)`;
                        }
                    }
                }
            }
        }
    });
}

function updateWealthChart() {
    const wealth = fortressData.wealth || {};
    const data = [
        { label: 'Weapons', value: wealth.weapons || 0 },
        { label: 'Armor', value: wealth.armor || 0 },
        { label: 'Furniture', value: wealth.furniture || 0 },
        { label: 'Other', value: wealth.other || 0 }
    ];
    
    const ctx = document.getElementById('wealthChart').getContext('2d');
    
    if (wealthChart) {
        wealthChart.destroy();
    }
    
    wealthChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: data.map(item => item.label),
            datasets: [{
                label: 'Value',
                data: data.map(item => item.value),
                backgroundColor: [
                    'rgba(255, 99, 132, 0.8)',
                    'rgba(54, 162, 235, 0.8)',
                    'rgba(255, 205, 86, 0.8)',
                    'rgba(75, 192, 192, 0.8)'
                ],
                borderColor: [
                    'rgba(255, 99, 132, 1)',
                    'rgba(54, 162, 235, 1)',
                    'rgba(255, 205, 86, 1)',
                    'rgba(75, 192, 192, 1)'
                ],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return value.toLocaleString();
                        }
                    }
                }
            },
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return `Value: ${context.parsed.y.toLocaleString()}`;
                        }
                    }
                }
            }
        }
    });
}

function updatePopulationDetails() {
    const population = fortressData.population || {};
    const container = document.getElementById('population-details');
    
    const details = [
        { icon: 'fas fa-hammer', label: 'Dwarven Citizens', value: population.dwarves || 0, color: 'text-primary' },
        { icon: 'fas fa-paw', label: 'Livestock & Pets', value: population.animals || 0, color: 'text-success' },
        { icon: 'fas fa-shield-alt', label: 'Military Forces', value: population.military || 0, color: 'text-warning' },
        { icon: 'fas fa-walking', label: 'Visitors', value: population.visitors || 0, color: 'text-info' }
    ];
    
    container.innerHTML = details.map(detail => `
        <div class="d-flex justify-content-between align-items-center mb-3 p-3 border rounded">
            <div class="d-flex align-items-center">
                <i class="${detail.icon} ${detail.color} me-3"></i>
                <span>${detail.label}</span>
            </div>
            <span class="badge bg-secondary fs-6">${detail.value}</span>
        </div>
    `).join('');
}

function updateWealthCategories() {
    const wealth = fortressData.wealth || {};
    const container = document.getElementById('wealth-categories');
    
    const categories = [
        { icon: 'fas fa-sword', label: 'Weapons', value: wealth.weapons || 0, color: 'text-danger' },
        { icon: 'fas fa-shield-alt', label: 'Armor', value: wealth.armor || 0, color: 'text-primary' },
        { icon: 'fas fa-chair', label: 'Furniture', value: wealth.furniture || 0, color: 'text-success' },
        { icon: 'fas fa-box', label: 'Other Items', value: wealth.other || 0, color: 'text-warning' }
    ];
    
    container.innerHTML = categories.map(category => `
        <div class="d-flex justify-content-between align-items-center mb-2">
            <div class="d-flex align-items-center">
                <i class="${category.icon} ${category.color} me-2"></i>
                <small>${category.label}</small>
            </div>
            <small class="fw-bold">${category.value.toLocaleString()}</small>
        </div>
    `).join('');
}

function updateFortressStatus() {
    const status = fortressData.status || 'Unknown';
    const mood = status === 'active' ? 'Content' : status;
    
    document.getElementById('fortress-mood').textContent = mood;
    document.getElementById('military-status').textContent = 
        fortressData.population?.military > 0 ? 'Active Defense' : 'No Military';
    document.getElementById('active-alerts').textContent = 
        fortressData.alerts?.length > 0 ? fortressData.alerts.join(', ') : 'None';
}

function updateAPIStatus(connected, error = null) {
    const container = document.getElementById('api-status');
    
    if (connected) {
        container.innerHTML = `
            <div class="d-flex align-items-center text-success">
                <i class="fas fa-check-circle me-2"></i>
                <span>API Connected - Data Available</span>
            </div>
        `;
    } else {
        container.innerHTML = `
            <div class="d-flex align-items-center text-danger">
                <i class="fas fa-times-circle me-2"></i>
                <span>API Disconnected${error ? ': ' + error : ''}</span>
            </div>
        `;
    }
}

function showError(message) {
    // Show sample data when no real data is available
    if (Object.keys(fortressData).length === 0) {
        showSampleData();
    }
}

function showSampleData() {
    // Use sample data for demonstration
    fortressData = {
        fortress_info: {
            name: "Sample Fortress",
            year: 125,
            season: "Late Spring"
        },
        population: {
            total: 156,
            dwarves: 134,
            animals: 22,
            military: 12,
            visitors: 0
        },
        wealth: {
            total: 485230,
            weapons: 12450,
            armor: 8900,
            furniture: 234500,
            other: 229380
        },
        status: "sample"
    };
    
    updateFortressDisplay();
    
    // Show sample data notice
    const apiStatus = document.getElementById('api-status');
    apiStatus.innerHTML = `
        <div class="d-flex align-items-center text-warning">
            <i class="fas fa-exclamation-triangle me-2"></i>
            <span>Showing Sample Data - No Live Game Data Available</span>
        </div>
    `;
}

async function exportFortressData() {
    if (Object.keys(fortressData).length === 0) {
        showToast('Warning', 'No fortress data to export', 'warning');
        return;
    }
    
    const dataStr = JSON.stringify(fortressData, null, 2);
    const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
    const filename = `fortress-data-${timestamp}.json`;
    
    const blob = new Blob([dataStr], { type: 'application/json' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);
    
    showToast('Success', 'Fortress data exported successfully', 'success');
}

// Initialize the page
document.addEventListener('DOMContentLoaded', function() {
    refreshFortressData();
    
    // Auto-refresh every 30 seconds
    setInterval(refreshFortressData, 30000);
});
</script>
{% endblock %}
